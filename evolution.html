<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–≤–æ–ª—é—Ü–∏—è –ù–ë–ê - NBA Charts</title>
    <link rel="stylesheet" href="shared.css">
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="site-navigation">
            <div class="nav-breadcrumb">
                <a href="index.html">NBA Charts</a> > –≠–≤–æ–ª—é—Ü–∏—è –ù–ë–ê
            </div>
            <div class="chart-navigation">
                <a href="pps-matrix.html" class="nav-button">üìä –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å vs –û–±—ä–µ–º</a>
                <a href="evolution.html" class="nav-button active">üìà –≠–≤–æ–ª—é—Ü–∏—è –ù–ë–ê</a>
            </div>
        </div>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1 class="main-title">–≠–≤–æ–ª—é—Ü–∏—è –ù–ë–ê</h1>
            <h2 class="subtitle">–ö–∞–∫ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∏–≥—Ä–∞ —Å 1997 –ø–æ 2025 –≥–æ–¥</h2>
            <p class="description">
                Stacked Area Chart –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –±—Ä–æ—Å–∫–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
            </p>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="chart-container">
            <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —ç–≤–æ–ª—é—Ü–∏–∏...</div>
            <svg id="evolution-chart" width="1000" height="700" style="display: none;"></svg>
        </div>
    </div>

    <!-- Hover tooltip -->
    <div id="hover-info" class="hover-info"></div>

    <script src="shared.js"></script>
    <script>
        let leagueData = [];

        // –°–æ–∑–¥–∞–Ω–∏–µ Stacked Area Chart
        async function createEvolutionChart() {
            leagueData = await NBA_Utils.loadLeagueData();
            
            if (leagueData.length === 0) {
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —ç–≤–æ–ª—é—Ü–∏–∏';
                return;
            }

            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
            document.getElementById('loading').style.display = 'none';
            document.getElementById('evolution-chart').style.display = 'block';

            const dimensions = NBA_Utils.getChartDimensions();
            const svg = d3.select('#evolution-chart');
            
            svg.attr('width', dimensions.width).attr('height', dimensions.height);
            
            const width = dimensions.width - dimensions.margin.left - dimensions.margin.right;
            const height = dimensions.height - dimensions.margin.top - dimensions.margin.bottom;

            const g = svg.append('g')
                .attr('transform', `translate(${dimensions.margin.left},${dimensions.margin.top})`);

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è stacked area
            const shotTypes = ['dunk', 'corner', '3pt_above', 'mid'];
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–µ–∑–æ–Ω–∞–º
            const dataBySeasonMap = {};
            leagueData.forEach(d => {
                if (!dataBySeasonMap[d.season]) {
                    dataBySeasonMap[d.season] = {
                        season: d.season,
                        year: NBA_Utils.parseYear(d.season)
                    };
                }
                dataBySeasonMap[d.season][d.shot_type] = d.rate * 100; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            });

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥–∞–º
            const dataBySeasonArray = Object.values(dataBySeasonMap)
                .filter(d => shotTypes.every(type => d[type] !== undefined)) // –¢–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                .sort((a, b) => a.year - b.year);

            // –°–æ–∑–¥–∞–µ–º stack
            const stack = d3.stack()
                .keys(shotTypes)
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetNone);

            const stackedData = stack(dataBySeasonArray);

            // Scales
            const xScale = d3.scaleLinear()
                .domain(d3.extent(dataBySeasonArray, d => d.year))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 100]) // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –æ—Ç 0 –¥–æ 100
                .range([height, 0]);

            // Area generator
            const area = d3.area()
                .x(d => xScale(d.data.year))
                .y0(d => yScale(d[0]))
                .y1(d => yScale(d[1]))
                .curve(d3.curveMonotoneX);

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É
            const xTicks = xScale.ticks(8);
            const yTicks = yScale.ticks(6);

            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
            g.selectAll('.x-grid')
                .data(xTicks)
                .enter()
                .append('line')
                .attr('x1', d => xScale(d))
                .attr('y1', 0)
                .attr('x2', d => xScale(d))
                .attr('y2', height)
                .attr('stroke', '#e8e4df')
                .attr('stroke-width', 1);

            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
            g.selectAll('.y-grid')
                .data(yTicks)
                .enter()
                .append('line')
                .attr('x1', 0)
                .attr('y1', d => yScale(d))
                .attr('x2', width)
                .attr('y2', d => yScale(d))
                .attr('stroke', '#e8e4df')
                .attr('stroke-width', 1);

            // –†–∏—Å—É–µ–º –æ–±–ª–∞—Å—Ç–∏
            g.selectAll('.area')
                .data(stackedData)
                .enter()
                .append('path')
                .attr('class', 'area')
                .attr('d', area)
                .attr('fill', d => NBA_COLORS[d.key])
                .attr('opacity', 0.8)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å
                    d3.select(this)
                        .attr('opacity', 1)
                        .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip –¥–ª—è –æ–±–ª–∞—Å—Ç–∏
                    const [mouseX, mouseY] = d3.pointer(event, g.node());
                    const bisect = d3.bisector(d => d.data.year).left;
                    const year = Math.round(xScale.invert(mouseX));
                    const dataPoint = d.find(point => point.data.year === year);
                    
                    if (dataPoint) {
                        const hoverInfo = document.getElementById('hover-info');
                        const percentage = dataPoint[1] - dataPoint[0];
                        hoverInfo.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 4px; font-size: 1rem;">${SHOT_TYPE_NAMES[d.key]}</div>
                            <div style="color: #bbb; margin-bottom: 12px;">–°–µ–∑–æ–Ω ${dataPoint.data.season}</div>
                            <div style="font-size: 0.85rem;">
                                <div>
                                    <div style="font-weight: bold; color: #fff;">${percentage.toFixed(1)}%</div>
                                    <div style="color: #aaa;">–î–æ–ª—è –æ—Ç –≤—Å–µ—Ö –±—Ä–æ—Å–∫–æ–≤</div>
                                </div>
                            </div>
                        `;
                        hoverInfo.style.display = 'block';
                    }
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .attr('opacity', 0.8)
                        .style('filter', 'none');
                    
                    document.getElementById('hover-info').style.display = 'none';
                });

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—É—Ä–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
            g.selectAll('.area-line')
                .data(stackedData)
                .enter()
                .append('path')
                .attr('class', 'area-line')
                .attr('d', d => {
                    const line = d3.line()
                        .x(d => xScale(d.data.year))
                        .y(d => yScale(d[1]))
                        .curve(d3.curveMonotoneX);
                    return line(d);
                })
                .attr('fill', 'none')
                .attr('stroke', 'white')
                .attr('stroke-width', 1)
                .attr('opacity', 0.7);

            // –°–æ–∑–¥–∞–µ–º –æ—Å–∏
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format('d')).ticks(8))
                .selectAll('text')
                .attr('class', 'tick-label');

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => d + '%').ticks(6))
                .selectAll('text')
                .attr('class', 'tick-label');

            // –ù–∞–∑–≤–∞–Ω–∏—è –æ—Å–µ–π
            g.append('text')
                .attr('class', 'axis-label')
                .attr('x', width / 2)
                .attr('y', height + dimensions.margin.bottom * 0.7)
                .attr('text-anchor', 'middle')
                .text('–ì–æ–¥');

            g.append('text')
                .attr('class', 'axis-label')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -dimensions.margin.left * 0.7)
                .attr('text-anchor', 'middle')
                .text('–î–æ–ª—è –æ—Ç –≤—Å–µ—Ö –±—Ä–æ—Å–∫–æ–≤ (%)');

            // –õ–µ–≥–µ–Ω–¥–∞
            const legend = g.append('g')
                .attr('transform', `translate(${width - 140}, 20)`);

            shotTypes.reverse().forEach((type, i) => {
                const legendItem = legend.append('g')
                    .attr('transform', `translate(0, ${i * 25})`);

                legendItem.append('rect')
                    .attr('width', 18)
                    .attr('height', 18)
                    .attr('fill', NBA_COLORS[type])
                    .attr('opacity', 0.8);

                legendItem.append('text')
                    .attr('x', 25)
                    .attr('y', 9)
                    .attr('dy', '0.35em')
                    .style('font-size', '0.8rem')
                    .style('fill', '#2c2c2c')
                    .text(SHOT_TYPE_NAMES[type]);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–æ–±—ã—Ç–∏–π
            const keyEvents = [
                { year: 2004, label: 'Handcheck rule', description: '–ó–∞–ø—Ä–µ—Ç –Ω–∞ handcheck' },
                { year: 2014, label: 'Analytics boom', description: '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≤–æ–ª—é—Ü–∏—è' },
                { year: 2016, label: 'Warriors 73-9', description: '–†–µ–∫–æ—Ä–¥ Warriors' }
            ];

            keyEvents.forEach(event => {
                const eventG = g.append('g')
                    .attr('transform', `translate(${xScale(event.year)}, 0)`);

                // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
                eventG.append('line')
                    .attr('y1', 0)
                    .attr('y2', height)
                    .attr('stroke', '#666')
                    .attr('stroke-width', 1)
                    .attr('stroke-dasharray', '3,3')
                    .attr('opacity', 0.5);

                // –ú–µ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
                eventG.append('text')
                    .attr('y', -10)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '0.7rem')
                    .style('fill', '#666')
                    .style('font-weight', 'bold')
                    .text(event.year);
            });
        }

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            d3.select('#evolution-chart').selectAll('*').remove();
            createEvolutionChart();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadD3(createEvolutionChart);
    </script>
</body>
</html>